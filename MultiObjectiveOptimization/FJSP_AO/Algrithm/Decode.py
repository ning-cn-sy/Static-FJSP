# -*- coding: utf-8 -*-
# @Time    : 2024/12/29 19:21
# @Author  : å®è¯—é“
# @Site    : 
# @File    : Decode.py
# @Software: PyCharm 
# @Comment : ç”¨äºè§£ç çš„ä¸€ç³»åˆ—å‡½æ•°
import time
from collections import deque

from MultiObjectiveOptimization.FJSP_AO.Config.Job import copy_job
from MultiObjectiveOptimization.FJSP_AO.Config.Operation import Assembling_operation
from MultiObjectiveOptimization.FJSP_AO.Util.Pub_func import is_type


def get_machine_available_time(if_allow_forward, machine_finished_times, prev_time_job, prev_time_assembly,
                               processing_time):
    """
    è®¡ç®—æœºå™¨çš„å¯ç”¨æ—¶é—´ã€‚

    åŠŸèƒ½ï¼š
    - æ ¹æ®æœºå™¨çš„ä½¿ç”¨æ—¶é—´ç‰‡æ®µï¼Œåˆ¤æ–­å½“å‰æ“ä½œå¯ä»¥åœ¨å“ªä¸ªæ—¶é—´æ®µå¼€å§‹ã€‚
    - å¦‚æœæ˜¯ä¸»åŠ¨è°ƒåº¦ï¼ˆ`if_allow_forward=True`ï¼‰ï¼Œé€šè¿‡æŸ¥æ‰¾æœºå™¨ç©ºé—²æ—¶é—´ç‰‡å®ç°æ“ä½œçš„å‰ç§»ä¼˜åŒ–ã€‚
    - å¦‚æœæ˜¯åŠä¸»åŠ¨è°ƒåº¦ï¼ˆ`if_allow_forward=False`ï¼‰ï¼Œåˆ™ç›´æ¥ä½¿ç”¨æœºå™¨çš„æœ€è¿‘ç»“æŸæ—¶é—´ä½œä¸ºå¯ç”¨æ—¶é—´ã€‚

    è°ƒåº¦é€»è¾‘ï¼š
    1. å¦‚æœæ˜¯ä¸»åŠ¨è°ƒåº¦ï¼š
        - è°ƒç”¨ `get_idle_times` æ–¹æ³•è·å–æœºå™¨çš„ç©ºé—²æ—¶é—´ç‰‡æ®µåˆ—è¡¨ã€‚
        - éå†ç©ºé—²æ—¶é—´ç‰‡æ®µï¼Œæ‰¾åˆ°ä¸€ä¸ªæ»¡è¶³æ“ä½œå¼€å§‹æ¡ä»¶çš„æ—¶é—´æ®µã€‚
        - æ£€æŸ¥ç©ºé—²æ—¶é—´ç‰‡æ®µæ˜¯å¦æœ‰è¶³å¤Ÿçš„å¤„ç†æ—¶é—´å®¹çº³å½“å‰æ“ä½œï¼š
            - è®¡ç®—ç©ºé—²æ—¶é—´æ®µçš„å®é™…å¯ç”¨æ—¶é—´ï¼Œå¹¶åˆ¤æ–­æ˜¯å¦æ»¡è¶³ `processing_time`ã€‚
            - å¦‚æœæ»¡è¶³ï¼Œåˆ™è¿”å›æ“ä½œçš„å¯ç”¨å¼€å§‹æ—¶é—´ã€‚
        - å¦‚æœæ²¡æœ‰åˆé€‚çš„æ—¶é—´ç‰‡ï¼Œåˆ™è¿”å›æœºå™¨çš„æœ€åç»“æŸæ—¶é—´ã€‚
    2. å¦‚æœæ˜¯åŠä¸»åŠ¨è°ƒåº¦ï¼š
        - ç›´æ¥è¿”å›æœºå™¨çš„æœ€åç»“æŸæ—¶é—´ï¼Œè¡¨ç¤ºä»æ­¤æ—¶é—´ç‚¹å¼€å§‹æ“ä½œã€‚

    Args:
        if_allow_forward (bool): æ˜¯å¦ä¸ºä¸»åŠ¨è°ƒåº¦ï¼ˆTrue è¡¨ç¤ºä¸»åŠ¨è°ƒåº¦ï¼Œå…è®¸å‰ç§»ä¼˜åŒ–ï¼‰ã€‚
        machine_finished_times (list of tuple): æœºå™¨çš„ä½¿ç”¨æ—¶é—´ç‰‡æ®µåˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç´ ä¸º (start, end)ï¼Œè¡¨ç¤ºæœºå™¨çš„å ç”¨æ—¶é—´æ®µã€‚
        prev_time_job (int): å½“å‰å·¥ä»¶å‰åºæ“ä½œçš„å®Œæˆæ—¶é—´ï¼Œå½“å‰æ“ä½œä¸èƒ½æ—©äºæ­¤æ—¶é—´å¼€å§‹ã€‚
        processing_time (int): å½“å‰æ“ä½œçš„å¤„ç†æ—¶é—´ã€‚

    Returns:
        int: å½“å‰æ“ä½œå¯ä»¥å¼€å§‹çš„æ—¶é—´ã€‚
    """
    if if_allow_forward:
        # ğŸˆ è·å–æœºå™¨çš„ç©ºé—²æ—¶é—´ç‰‡æ®µ
        idle_times = get_idle_times(machine_finished_times)
        # ğŸˆ éå†æ‰€æœ‰ç©ºé—²æ—¶é—´ç‰‡æ®µ
        for idle_time in idle_times:
            # ğŸˆ è®¡ç®—å½“å‰æ—¶é—´ç‰‡æ®µçš„å¯ç”¨å¼€å§‹æ—¶é—´
            # æ“ä½œå¿…é¡»æ»¡è¶³å‰åºæ“ä½œçš„å®Œæˆæ—¶é—´
            available_start_time = max(idle_time[0], prev_time_job, prev_time_assembly)
            # ğŸˆ è®¡ç®—å½“å‰æ—¶é—´ç‰‡æ®µçš„å‰©ä½™å¯ç”¨æ—¶é—´
            available_time = idle_time[1] - available_start_time
            # ğŸˆ å¦‚æœå½“å‰ç©ºé—²æ—¶é—´ç‰‡æ®µå¯ä»¥å®¹çº³æ“ä½œï¼Œåˆ™è¿”å›æ“ä½œçš„å¯ç”¨å¼€å§‹æ—¶é—´
            if available_time > processing_time:
                return available_start_time
        # ğŸˆ å¦‚æœæ²¡æœ‰åˆé€‚çš„ç©ºé—²æ—¶é—´ç‰‡ï¼Œè¿”å›æœºå™¨çš„æœ€åç»“æŸæ—¶é—´
        return machine_finished_times[-1][1]
    else:
        # ğŸˆ åŠä¸»åŠ¨è°ƒåº¦ï¼Œç›´æ¥è¿”å›æœºå™¨çš„æœ€åç»“æŸæ—¶é—´
        return machine_finished_times[-1][1]


def get_idle_times(machine_finished_times):
    """
    è·å–æœºå™¨çš„ç©ºé—²æ—¶é—´æ®µã€‚

    åŠŸèƒ½ï¼š
    - æ ¹æ®æœºå™¨çš„å·²ç”¨æ—¶é—´ç‰‡æ®µï¼Œè®¡ç®—æ‰€æœ‰çš„ç©ºé—²æ—¶é—´æ®µã€‚
    - å‡è®¾è¾“å…¥çš„æ—¶é—´ç‰‡æ®µæ˜¯æœ‰åºçš„ï¼Œå¹¶ä¸”è¡¨ç¤ºæœºå™¨çš„å®é™…å ç”¨æ—¶é—´ã€‚

    è°ƒåº¦é€»è¾‘ï¼š
    1. åˆå§‹åŒ–ä¸€ä¸ªç©ºåˆ—è¡¨ `idle_times`ï¼Œç”¨äºå­˜å‚¨ç©ºé—²æ—¶é—´æ®µã€‚
    2. éå†æœºå™¨çš„ä½¿ç”¨æ—¶é—´ç‰‡æ®µï¼š
        - å¦‚æœå½“å‰æ—¶é—´ç‰‡æ®µçš„å¼€å§‹æ—¶é—´å¤§äºå‰ä¸€ä¸ªæ—¶é—´ç‰‡æ®µçš„ç»“æŸæ—¶é—´ï¼Œè¯´æ˜æœ‰ç©ºé—²æ—¶é—´æ®µã€‚
        - å°†ç©ºé—²æ—¶é—´æ®µ (prev_end, start) æ·»åŠ åˆ°åˆ—è¡¨ä¸­ã€‚
    3. è¿”å›è®¡ç®—å¾—åˆ°çš„ç©ºé—²æ—¶é—´æ®µåˆ—è¡¨ã€‚

    Args:
        machine_finished_times (list of tuple): å·²ç”¨æ—¶é—´æ®µåˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç´ ä¸º (start, end)ï¼Œ
                                                è¡¨ç¤ºæŸæ®µæ—¶é—´å†…æœºå™¨è¢«å ç”¨ã€‚
                                                å‡è®¾è¾“å…¥çš„æ—¶é—´æ®µæ˜¯æœ‰åºçš„ã€‚

    Returns:
        list of tuple: ç©ºé—²æ—¶é—´æ®µåˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç´ ä¸º (start, end)ï¼Œè¡¨ç¤ºæœºå™¨ç©ºé—²çš„æ—¶é—´æ®µã€‚
    """
    # åˆå§‹åŒ–ç©ºé—²æ—¶é—´æ®µåˆ—è¡¨
    idle_times = []

    # å‡è®¾æœºå™¨ä»æ—¶é—´ 0 å¼€å§‹ï¼Œè®°å½•ä¸Šä¸€ä¸ªä»»åŠ¡çš„ç»“æŸæ—¶é—´
    prev_end = 0

    # éå†å·²ç”¨æ—¶é—´æ®µ
    for start, end in machine_finished_times:
        # ğŸˆ å¦‚æœå½“å‰ä»»åŠ¡çš„å¼€å§‹æ—¶é—´å¤§äºä¸Šä¸€ä¸ªä»»åŠ¡çš„ç»“æŸæ—¶é—´ï¼Œè¯´æ˜æœ‰ç©ºé—²
        if start > prev_end:
            idle_times.append((prev_end, start))  # æ·»åŠ ç©ºé—²æ—¶é—´æ®µ
        # ğŸˆ æ›´æ–°ä¸Šä¸€ä¸ªä»»åŠ¡çš„ç»“æŸæ—¶é—´
        prev_end = max(prev_end, end)

    # ğŸˆ è¿”å›æ‰€æœ‰è®¡ç®—å‡ºçš„ç©ºé—²æ—¶é—´æ®µ
    return idle_times


def get_whole_machine_idle_times(machines_finished_times):
    """
    è·å–æœºå™¨çš„ç©ºé—²æ—¶é—´æ®µã€‚

    åŠŸèƒ½ï¼š
    - æ ¹æ®æœºå™¨çš„å·²ç”¨æ—¶é—´ç‰‡æ®µï¼Œè®¡ç®—æ‰€æœ‰çš„ç©ºé—²æ—¶é—´æ®µã€‚
    - å‡è®¾è¾“å…¥çš„æ—¶é—´ç‰‡æ®µæ˜¯æœ‰åºçš„ï¼Œå¹¶ä¸”è¡¨ç¤ºæœºå™¨çš„å®é™…å ç”¨æ—¶é—´ã€‚

    è°ƒåº¦é€»è¾‘ï¼š
    1. åˆå§‹åŒ–ä¸€ä¸ªç©ºåˆ—è¡¨ `idle_times`ï¼Œç”¨äºå­˜å‚¨ç©ºé—²æ—¶é—´æ®µã€‚
    2. éå†æœºå™¨çš„ä½¿ç”¨æ—¶é—´ç‰‡æ®µï¼š
        - å¦‚æœå½“å‰æ—¶é—´ç‰‡æ®µçš„å¼€å§‹æ—¶é—´å¤§äºå‰ä¸€ä¸ªæ—¶é—´ç‰‡æ®µçš„ç»“æŸæ—¶é—´ï¼Œè¯´æ˜æœ‰ç©ºé—²æ—¶é—´æ®µã€‚
        - å°†ç©ºé—²æ—¶é—´æ®µ (prev_end, start) æ·»åŠ åˆ°åˆ—è¡¨ä¸­ã€‚
    3. è¿”å›è®¡ç®—å¾—åˆ°çš„ç©ºé—²æ—¶é—´æ®µåˆ—è¡¨ã€‚

    Args:
        machine_finished_times (list of tuple): å·²ç”¨æ—¶é—´æ®µåˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç´ ä¸º (start, end)ï¼Œ
                                                è¡¨ç¤ºæŸæ®µæ—¶é—´å†…æœºå™¨è¢«å ç”¨ã€‚
                                                å‡è®¾è¾“å…¥çš„æ—¶é—´æ®µæ˜¯æœ‰åºçš„ã€‚

    Returns:
        list of tuple: ç©ºé—²æ—¶é—´æ®µåˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç´ ä¸º (start, end)ï¼Œè¡¨ç¤ºæœºå™¨ç©ºé—²çš„æ—¶é—´æ®µã€‚
    """
    # åˆå§‹åŒ–ç©ºé—²æ—¶é—´æ®µåˆ—è¡¨
    idle_times = [[] for _ in machines_finished_times]

    # éå†å·²ç”¨æ—¶é—´æ®µ
    for i, machine in enumerate(machines_finished_times):
        prev_end = 0
        for start, end in machine:
            # ğŸˆ å¦‚æœå½“å‰ä»»åŠ¡çš„å¼€å§‹æ—¶é—´å¤§äºä¸Šä¸€ä¸ªä»»åŠ¡çš„ç»“æŸæ—¶é—´ï¼Œè¯´æ˜æœ‰ç©ºé—²
            if start > prev_end:
                idle_times[i].append((prev_end, start))  # æ·»åŠ ç©ºé—²æ—¶é—´æ®µ
            # ğŸˆ æ›´æ–°ä¸Šä¸€ä¸ªä»»åŠ¡çš„ç»“æŸæ—¶é—´
            prev_end = max(prev_end, end)

    # ğŸˆ è¿”å›æ‰€æœ‰è®¡ç®—å‡ºçš„ç©ºé—²æ—¶é—´æ®µ
    return idle_times


def get_job_delay_times(job_finished_times):
    """
    è®¡ç®—æ¯ä¸ªä½œä¸šçš„ç©ºé—²æ—¶é—´æ®µã€‚

    åŠŸèƒ½ï¼š
    - æ ¹æ®ä½œä¸šçš„å®Œæˆæ—¶é—´æ®µï¼Œè®¡ç®—æ¯ä¸ªä½œä¸šçš„ç©ºé—²æ—¶é—´æ®µã€‚
    - å‡è®¾è¾“å…¥çš„æ—¶é—´æ®µæ˜¯æœ‰åºçš„ï¼Œå¹¶ä¸”è¡¨ç¤ºä½œä¸šçš„å®é™…å ç”¨æ—¶é—´ã€‚

    è®¡ç®—é€»è¾‘ï¼š
    1. åˆå§‹åŒ–ä¸€ä¸ªç©ºåˆ—è¡¨ `idle_times`ï¼Œç”¨äºå­˜å‚¨æ¯ä¸ªä½œä¸šçš„ç©ºé—²æ—¶é—´æ®µã€‚
    2. éå†æ¯ä¸ªä½œä¸šçš„å®Œæˆæ—¶é—´æ®µï¼š
        - å¦‚æœå½“å‰æ—¶é—´æ®µçš„å¼€å§‹æ—¶é—´å¤§äºä¸Šä¸€ä¸ªæ—¶é—´æ®µçš„ç»“æŸæ—¶é—´ï¼Œè¯´æ˜æœ‰ç©ºé—²æ—¶é—´æ®µã€‚
        - å°†ç©ºé—²æ—¶é—´æ®µ (prev_end, start) æ·»åŠ åˆ°å¯¹åº”ä½œä¸šçš„ç©ºé—²æ—¶é—´åˆ—è¡¨ä¸­ã€‚
        - æ›´æ–°ä¸Šä¸€ä¸ªæ—¶é—´æ®µçš„ç»“æŸæ—¶é—´ã€‚
    3. è¿”å›æ‰€æœ‰ä½œä¸šçš„ç©ºé—²æ—¶é—´æ®µåˆ—è¡¨ã€‚

    å‚æ•°:
        job_finished_times (list of list of tuple):
            æ¯ä¸ªä½œä¸šçš„å®Œæˆæ—¶é—´æ®µåˆ—è¡¨ï¼Œå¤–å±‚åˆ—è¡¨åŒ…å«å¤šä¸ªä½œä¸šï¼Œæ¯ä¸ªä½œä¸šçš„æ—¶é—´æ®µä¸ºä¸€ä¸ªåˆ—è¡¨ã€‚
            æ—¶é—´æ®µçš„æ ¼å¼ä¸º (start, end)ï¼Œè¡¨ç¤ºä½œä¸šåœ¨æŸæ®µæ—¶é—´å†…çš„è¿è¡Œæ—¶é—´ã€‚
            å‡è®¾è¾“å…¥çš„æ—¶é—´æ®µæ˜¯æœ‰åºçš„ã€‚

    è¿”å›å€¼:
        list of list of tuple:
            æ¯ä¸ªä½œä¸šçš„ç©ºé—²æ—¶é—´æ®µåˆ—è¡¨ï¼Œå¤–å±‚åˆ—è¡¨åŒ…å«å¤šä¸ªä½œä¸šï¼Œæ¯ä¸ªä½œä¸šçš„ç©ºé—²æ—¶é—´æ®µä¸ºä¸€ä¸ªåˆ—è¡¨ã€‚
            æ¯ä¸ªç©ºé—²æ—¶é—´æ®µçš„æ ¼å¼ä¸º (start, end)ï¼Œè¡¨ç¤ºè¯¥ä½œä¸šçš„ç©ºé—²æ—¶é—´æ®µã€‚
    """
    # åˆå§‹åŒ–ç©ºé—²æ—¶é—´æ®µåˆ—è¡¨
    idle_times = [[] for _ in job_finished_times]

    # éå†æ¯ä¸ªä½œä¸šçš„å®Œæˆæ—¶é—´æ®µ
    for i, job in enumerate(job_finished_times):
        prev_end = 0  # åˆå§‹åŒ–ä¸Šä¸€ä¸ªæ—¶é—´æ®µçš„ç»“æŸæ—¶é—´
        for start, end in job:
            # å¦‚æœå½“å‰æ—¶é—´æ®µçš„å¼€å§‹æ—¶é—´å¤§äºä¸Šä¸€ä¸ªæ—¶é—´æ®µçš„ç»“æŸæ—¶é—´ï¼Œè®¡ç®—ç©ºé—²æ—¶é—´æ®µ
            if start > prev_end:
                idle_times[i].append((prev_end, start))  # æ·»åŠ ç©ºé—²æ—¶é—´æ®µ
            # æ›´æ–°ä¸Šä¸€ä¸ªæ—¶é—´æ®µçš„ç»“æŸæ—¶é—´
            prev_end = max(prev_end, end)

    # è¿”å›æ‰€æœ‰ä½œä¸šçš„ç©ºé—²æ—¶é—´æ®µåˆ—è¡¨
    return idle_times


class Decode:
    """
    Decodeç±»ç”¨äºç”ŸæˆæŸ”æ€§ä½œä¸šè½¦é—´è°ƒåº¦æ–¹æ¡ˆï¼Œæ”¯æŒä¸‰ç§è°ƒåº¦æ–¹å¼ï¼š
    1. åŠä¸»åŠ¨è°ƒåº¦ï¼ˆSemi-active schedulingï¼‰ï¼šæŒ‰ç…§ç»™å®šé¡ºåºå’Œæœºå™¨é€‰æ‹©ï¼Œå°½æ—©å®‰æ’æ“ä½œã€‚
    2. ä¸»åŠ¨è°ƒåº¦ï¼ˆActive schedulingï¼‰ï¼šè°ƒæ•´å†²çªï¼Œä¼˜åŒ–è°ƒåº¦ã€‚
    3. å…¨ä¸»åŠ¨è°ƒåº¦ï¼ˆFully active schedulingï¼‰ï¼šåŠ¨æ€é€‰æ‹©æ“ä½œå’Œæœºå™¨ï¼Œå®ç°å…¨å±€ä¼˜åŒ–ã€‚
    """

    def __init__(self, jobs, machines, assemble_styles, need_styles):
        """
        åˆå§‹åŒ–Decodeç±»å®ä¾‹ã€‚

        åŠŸèƒ½ï¼š
        - å°†ä¼ å…¥çš„å·¥ä»¶åˆ—è¡¨ã€æœºå™¨åˆ—è¡¨å’Œè£…é…è§„åˆ™åˆ—è¡¨åˆå§‹åŒ–åˆ°ç±»å®ä¾‹ä¸­ã€‚
        - æ·±æ‹·è´å·¥ä»¶åˆ—è¡¨ï¼Œé¿å…ç›´æ¥ä¿®æ”¹ä¼ å…¥çš„å·¥ä»¶å¯¹è±¡ã€‚
        - åˆå§‹åŒ–æœºå™¨ä¿¡æ¯å’Œè£…é…è§„åˆ™ï¼Œåˆ†åˆ«ä½œä¸ºç±»çš„å±æ€§ä¿å­˜ã€‚
        - æ¸…ç©ºæ¯ä¸ªå·¥ä»¶çš„æ“ä½œé˜Ÿåˆ—ï¼Œä¸ºåç»­è°ƒåº¦æ“ä½œåšå‡†å¤‡ã€‚

        Args:
            jobs (list): å·¥ä»¶å¯¹è±¡åˆ—è¡¨ï¼Œè¡¨ç¤ºå¾…è°ƒåº¦çš„æ‰€æœ‰å·¥ä»¶ï¼Œæ¯ä¸ªå·¥ä»¶åŒ…å«å¤šä¸ªæ“ä½œï¼ˆoperationsï¼‰ã€‚
            machines (list): æœºå™¨å¯¹è±¡åˆ—è¡¨ï¼Œè¡¨ç¤ºå¯ç”¨çš„æ‰€æœ‰æœºå™¨ï¼Œæ¯å°æœºå™¨å¯ä»¥æ‰§è¡Œä¸åŒçš„æ“ä½œã€‚
            assemble_styles (list): è£…é…è§„åˆ™åˆ—è¡¨ï¼Œå®šä¹‰äº†è£…é…æ“ä½œæ‰€éœ€çš„è§„åˆ™ï¼Œæ¯”å¦‚éœ€è¦çš„å·¥ä»¶ç±»å‹å’ŒåŒ¹é…æ¡ä»¶ã€‚

        å˜é‡åˆå§‹åŒ–è¿‡ç¨‹ï¼š
        - `self.jobs`ï¼šå°†ä¼ å…¥çš„å·¥ä»¶å¯¹è±¡åˆ—è¡¨æ·±æ‹·è´åå­˜å‚¨ï¼Œç¡®ä¿æ“ä½œè¿‡ç¨‹ä¸­ä¸ä¼šä¿®æ”¹åŸå§‹æ•°æ®ã€‚
        - `self.machines`ï¼šç®€å•å¤åˆ¶ä¼ å…¥çš„æœºå™¨åˆ—è¡¨ï¼Œç”¨äºè°ƒåº¦æ—¶çš„æœºå™¨åˆ†é…ã€‚
        - `self.assemble_styles`ï¼šå¤åˆ¶ä¼ å…¥çš„è£…é…è§„åˆ™åˆ—è¡¨ï¼Œç”¨äºè£…é…æ“ä½œçš„åŒ¹é…é€»è¾‘ã€‚

        ç»†èŠ‚è¯´æ˜ï¼š
        - ä½¿ç”¨ `copy_job(job)` æ–¹æ³•å¯¹æ¯ä¸ªå·¥ä»¶å¯¹è±¡è¿›è¡Œæ·±æ‹·è´ï¼Œç¡®ä¿æ¯ä¸ªå·¥ä»¶åœ¨è°ƒåº¦ä¸­çš„çŠ¶æ€å˜åŒ–äº’ä¸å½±å“ã€‚
        - è°ƒç”¨æ¯ä¸ªå·¥ä»¶å¯¹è±¡çš„ `clear_ops()` æ–¹æ³•ï¼Œæ¸…ç©ºå…¶æ“ä½œé˜Ÿåˆ—ï¼Œä¸ºæ–°çš„è°ƒåº¦è¿‡ç¨‹é‡æ–°åˆå§‹åŒ–æ“ä½œã€‚
        """
        self.jobs = []  # ğŸˆ åˆå§‹åŒ–å·¥ä»¶åˆ—è¡¨ï¼Œç”¨äºå­˜å‚¨æ‰€æœ‰å¾…è°ƒåº¦çš„å·¥ä»¶
        for job in jobs:
            self.jobs.append(copy_job(job))  # ğŸˆ æ·±æ‹·è´æ¯ä¸ªå·¥ä»¶å¯¹è±¡ï¼Œç¡®ä¿è°ƒåº¦è¿‡ç¨‹ä¸­çš„ç‹¬ç«‹æ€§
        # ğŸˆ æ¸…ç©ºæ¯ä¸ªå·¥ä»¶çš„æ“ä½œé˜Ÿåˆ—ï¼Œä¸ºè°ƒåº¦è¿‡ç¨‹åšå‡†å¤‡
        for job in self.jobs:
            job.clear_ops()
        # ğŸˆ åˆå§‹åŒ–æœºå™¨åˆ—è¡¨ï¼Œå­˜å‚¨æ‰€æœ‰å¯ç”¨æœºå™¨çš„ä¿¡æ¯
        self.machines = machines.copy()
        self.assemble_styles = assemble_styles.copy()  # ğŸˆ åˆå§‹åŒ–è£…é…è§„åˆ™åˆ—è¡¨ï¼Œç”¨äºè£…é…æ“ä½œçš„è§„åˆ™åŒ¹é…
        self.need_styles = need_styles.copy()
        self.job_finished_times = [[] for _ in jobs]
        self.machines_energy_usage = [0 for _ in machines]
        self.machines_idle_energy_usage = [0 for _ in machines]
        self.job_delay_time = []
        self.assemble_jobs = []

    def run_semi_active_schedule(self, temp_sequence, machine_selection, assembly_selection):
        """
        åŠä¸»åŠ¨è°ƒåº¦ï¼šæŒ‰ç…§ç»™å®šé¡ºåºå°½æ—©å®‰æ’æ“ä½œï¼ˆä¸è¿›è¡Œå‰ç§»ä¼˜åŒ–ï¼‰ã€‚

        è°ƒåº¦é€»è¾‘ï¼š
        - ä½¿ç”¨ `run_schedule` æ–¹æ³•å®ŒæˆåŠä¸»åŠ¨è°ƒåº¦ã€‚
        - è®¾ç½® `if_allow_forward=False`ï¼Œè¡¨ç¤ºä¸è¿›è¡Œå‰ç§»ä¼˜åŒ–ã€‚

        Args:
            temp_sequence (list): æ“ä½œé¡ºåºåˆ—è¡¨ï¼Œè¡¨ç¤ºå…¨å±€æ“ä½œçš„æ‰§è¡Œé¡ºåºã€‚
                                  æ¯ä¸ªå…ƒç´ ä¸ºå…¨å±€æ“ä½œç´¢å¼•ï¼Œå®šä¹‰äº†è§£ç é¡ºåºã€‚
            machine_selection (list): æ¯ä¸ªæ“ä½œå¯¹åº”çš„æœºå™¨é€‰æ‹©ç­–ç•¥åˆ—è¡¨ã€‚
                                      æ¯ä¸ªå…ƒç´ ä¸ºæœºå™¨ç´¢å¼•ï¼Œè¡¨ç¤ºè¯¥æ“ä½œåˆ†é…çš„æœºå™¨ã€‚

        Returns:
            None
        """
        self.run_schedule(temp_sequence, machine_selection, assembly_selection, False)

    def run_active_schedule(self, temp_sequence, machine_selection, assembly_selection):
        """
        ä¸»åŠ¨è°ƒåº¦ï¼šé€šè¿‡å‰ç§»ä¼˜åŒ–ç­‰å¾…æ—¶é—´ã€‚

        è°ƒåº¦é€»è¾‘ï¼š
        - ä½¿ç”¨ `run_schedule` æ–¹æ³•å®Œæˆä¸»åŠ¨è°ƒåº¦ã€‚
        - è®¾ç½® `if_allow_forward=True`ï¼Œè¡¨ç¤ºæ‰§è¡Œå‰ç§»ä¼˜åŒ–ã€‚

        Args:
            temp_sequence (list): æ“ä½œé¡ºåºåˆ—è¡¨ï¼Œè¡¨ç¤ºå…¨å±€æ“ä½œçš„æ‰§è¡Œé¡ºåºã€‚
                                  æ¯ä¸ªå…ƒç´ ä¸ºå…¨å±€æ“ä½œç´¢å¼•ï¼Œå®šä¹‰äº†è§£ç é¡ºåºã€‚
            machine_selection (list): æ¯ä¸ªæ“ä½œå¯¹åº”çš„æœºå™¨é€‰æ‹©ç­–ç•¥åˆ—è¡¨ã€‚
                                      æ¯ä¸ªå…ƒç´ ä¸ºæœºå™¨ç´¢å¼•ï¼Œè¡¨ç¤ºè¯¥æ“ä½œåˆ†é…çš„æœºå™¨ã€‚

        Returns:
            None
        """
        self.run_schedule(temp_sequence, machine_selection, assembly_selection, True)

    def run_schedule(self, temp_sequence, machine_selection, assembly_selection, if_allow_forward):
        """
        æ ¸å¿ƒè°ƒåº¦æ–¹æ³•ï¼šæ”¯æŒåŠä¸»åŠ¨è°ƒåº¦å’Œä¸»åŠ¨è°ƒåº¦ã€‚

        æ ¹æ® `if_allow_forward` å‚æ•°å†³å®šæ˜¯å¦è¿›è¡Œä¸»åŠ¨è°ƒåº¦ï¼ˆå³å‰ç§»ä¼˜åŒ–ï¼‰ã€‚
        - å½“ `if_allow_forward=False` æ—¶ï¼Œæ‰§è¡ŒåŠä¸»åŠ¨è°ƒåº¦ï¼š
            - æŒ‰ç…§å›ºå®šçš„æ“ä½œé¡ºåºå’Œæœºå™¨åˆ†é…ï¼Œå°½æ—©å®‰æ’æ“ä½œã€‚
        - å½“ `if_allow_forward=True` æ—¶ï¼Œæ‰§è¡Œä¸»åŠ¨è°ƒåº¦ï¼š
            - åœ¨å°½æ—©å®‰æ’æ“ä½œçš„åŸºç¡€ä¸Šï¼ŒåŠ¨æ€å‰ç§»ä»»åŠ¡ï¼Œä¼˜åŒ–ç­‰å¾…æ—¶é—´ã€‚

        è°ƒåº¦é€»è¾‘ï¼š
        1. åˆå§‹åŒ–æ‰€éœ€çš„å·¥ä»¶ã€æœºå™¨å®Œæˆæ—¶é—´è®°å½•å’Œè£…é…é˜Ÿåˆ—ã€‚
        2. éå†ç»™å®šçš„æ“ä½œé¡ºåºï¼ˆtemp_sequenceï¼‰ï¼Œé€æ­¥è°ƒåº¦æ¯ä¸ªæ“ä½œã€‚
        3. å¯¹äºæ¯ä¸ªæ“ä½œï¼š
            - æ£€æŸ¥è£…é…æ“ä½œæ˜¯å¦æ»¡è¶³æ¡ä»¶ï¼ˆå¦‚æœ‰ï¼‰ã€‚
            - å¦‚æœæ˜¯ä¸»åŠ¨è°ƒåº¦ï¼ˆif_allow_forward=Trueï¼‰ï¼Œæ‰§è¡Œå‰ç§»é€»è¾‘ã€‚
            - è°ƒç”¨ `_schedule_operation` æ–¹æ³•å®‰æ’æ“ä½œï¼Œæ›´æ–°å®Œæˆæ—¶é—´è®°å½•ã€‚
        4. é€šè¿‡åŠ¨æ€ä¼˜åŒ–å‡å°‘ç­‰å¾…æ—¶é—´ï¼Œæé«˜èµ„æºåˆ©ç”¨ç‡ã€‚

        Args:
            temp_sequence (list): æ“ä½œé¡ºåºåˆ—è¡¨ï¼Œè¡¨ç¤ºå…¨å±€æ“ä½œçš„æ‰§è¡Œé¡ºåºã€‚
                                  æ¯ä¸ªå…ƒç´ ä¸ºå…¨å±€æ“ä½œç´¢å¼•ï¼Œå®šä¹‰äº†è§£ç é¡ºåºã€‚
            machine_selection (list): æ¯ä¸ªæ“ä½œå¯¹åº”çš„æœºå™¨é€‰æ‹©ç­–ç•¥åˆ—è¡¨ã€‚
                                      æ¯ä¸ªå…ƒç´ ä¸ºæœºå™¨ç´¢å¼•ï¼Œè¡¨ç¤ºè¯¥æ“ä½œåˆ†é…çš„æœºå™¨ã€‚
            if_allow_forward (bool): æ˜¯å¦è¿›è¡Œä¸»åŠ¨è°ƒåº¦ï¼ˆå‰ç§»ä¼˜åŒ–ï¼‰ã€‚
                               - Falseï¼šæ‰§è¡ŒåŠä¸»åŠ¨è°ƒåº¦ã€‚
                               - Trueï¼šæ‰§è¡Œä¸»åŠ¨è°ƒåº¦ã€‚

        Returns:
            None
            @param if_allow_forward:
            @param temp_sequence:
            @param machine_selection:
            @param assembly_selection:
        """
        # --------------- âœŒï¸å‡†å¤‡æ‰€éœ€æ•°æ®(begin)âœŒï¸ ---------------
        # ğŸˆ å·¥ä»¶çš„å®Œæˆæ—¶é—´è®°å½•
        # æ¯ä¸ªå·¥ä»¶æœ‰ä¸€ä¸ªå®Œæˆæ—¶é—´è®°å½•åˆ—è¡¨ï¼Œä»¥å·¥ä»¶çš„é‡Šæ”¾æ—¶é—´ï¼ˆrelease_timeï¼‰åˆå§‹åŒ–ã€‚
        # ä¾‹å¦‚ï¼šjob_finished_times[job_id - 1] ä¼šå­˜å‚¨è¯¥å·¥ä»¶æ¯ä¸ªæ“ä½œçš„å®Œæˆæ—¶é—´ã€‚
        self.job_finished_times = [[(0, job.release_time)] for job in self.jobs]

        # ğŸˆ æ¯å°æœºå™¨çš„å®Œæˆæ—¶é—´è®°å½•
        # æ¯å°æœºå™¨æœ‰ä¸€ä¸ªå®Œæˆæ—¶é—´è®°å½•åˆ—è¡¨ï¼Œåˆå§‹åŒ–ä¸º0ï¼Œè¡¨ç¤ºæœºå™¨æœ€æ—©ä»æ—¶é—´0å¼€å§‹å¯ç”¨ã€‚
        # ä¾‹å¦‚ï¼šmachines_finished_times[machine_id - 1] å­˜å‚¨æ¯å°æœºå™¨çš„å®Œæˆæ—¶é—´ã€‚
        machines_finished_times = [[(0, 0)] for _ in self.machines]
        self.assemble_jobs = self.get_assembly_jobs(assembly_selection)
        # ğŸˆ è£…é…é˜Ÿåˆ—
        # ç”¨äºç®¡ç†è£…é…æ“ä½œæ—¶çš„å·¥ä»¶ç­‰å¾…é˜Ÿåˆ—ã€‚æ ¹æ®è£…é…è§„åˆ™ä¸­çš„å·¥ä»¶ç±»å‹è¿›è¡Œåˆ†ç»„ã€‚
        # æ¯ç§å·¥ä»¶ç±»å‹éƒ½æœ‰ä¸€ä¸ªé˜Ÿåˆ—ï¼Œè®°å½•éœ€è¦è£…é…çš„å·¥ä»¶ã€‚
        assembly_queue = self._initialize_assembly_queue()

        # ğŸˆ æ ¹æ®ä½œä¸šé¡ºåºï¼ˆtemp_sequenceï¼‰ç”Ÿæˆå®é™…çš„æ“ä½œè°ƒåº¦é¡ºåºã€‚
        # `temp_sequence` æ˜¯å…¨å±€æ“ä½œç´¢å¼•ï¼Œå°†å…¶è½¬æ¢ä¸ºå·¥ä»¶IDåˆ—è¡¨ï¼Œä¾¿äºé€å·¥ä»¶å¤„ç†ã€‚
        # ä¾‹å¦‚ï¼š[3, 2, 1] -> [å·¥ä»¶3çš„æ“ä½œ, å·¥ä»¶2çš„æ“ä½œ, å·¥ä»¶1çš„æ“ä½œ]ã€‚
        operation_sequencing = self.sequence_operations_by_job(temp_sequence)
        # --------------- âœŒï¸å‡†å¤‡æ‰€éœ€æ•°æ®(end)âœŒï¸ ---------------

        # --------------- âœŒï¸è°ƒåº¦æ‰€æœ‰å·¥åº(begin)âœŒï¸ ---------------
        # éå†è°ƒåº¦é¡ºåºï¼Œä¾æ¬¡è°ƒåº¦æ¯ä¸ªæ“ä½œã€‚
        for op_index in range(len(operation_sequencing)):
            # ğŸˆ è·å–å½“å‰æ“ä½œå¯¹åº”çš„å·¥ä»¶IDã€‚
            job_id = operation_sequencing[op_index]
            # if job_id == 10 or job_id == 12:
            #     print()

            # ğŸˆ é€šè¿‡å·¥ä»¶å®Œæˆæ—¶é—´åˆ—è¡¨çš„é•¿åº¦æ¨å¯¼å½“å‰æ“ä½œIDã€‚

            op_id = len(self.job_finished_times[job_id - 1])

            # ğŸˆ è·å–å½“å‰å·¥ä»¶å’Œæ“ä½œå¯¹è±¡ã€‚
            job = self.jobs[job_id - 1]

            # ç›¸å½“äºè¿™ä¸ªå·¥åºå·²ç»å®Œæˆäº†
            if op_id > len(job.ops):
                continue

            op = job.ops[op_id - 1]

            # ğŸˆ åˆå§‹åŒ–è£…é…å®Œæˆæ—¶é—´ã€‚
            prev_time_assembly = -1  # é»˜è®¤ä¸º -1ï¼Œè¡¨ç¤ºæ— éœ€è£…é…ã€‚
            job_need = None
            # ğŸˆ æ£€æŸ¥å½“å‰æ“ä½œæ˜¯å¦ä¸ºè£…é…æ“ä½œã€‚
            if is_type(op, Assembling_operation):
                # æ£€æŸ¥æ˜¯å¦å¯ä»¥è¿›è¡Œè£…é…æ“ä½œã€‚
                prev_time_assembly, job_need = self._can_assemble(job, op, assembly_queue, self.job_finished_times)

                if prev_time_assembly < 0:
                    # å¦‚æœè£…é…æ¡ä»¶æœªæ»¡è¶³, è®°å½•è¯¥å·¥ä»¶æœ€æ–°çš„å®Œæˆæ—¶é—´, å¹¶è·³è¿‡ã€‚
                    # job_finished_times[job_id - 1].append(job_finished_times[job_id - 1][-1])
                    continue

            # ğŸˆ è°ƒåº¦å½“å‰æ“ä½œã€‚
            # è°ƒåº¦çš„æ ¸å¿ƒé€»è¾‘ï¼šåŒ…æ‹¬è®¡ç®—å¼€å§‹æ—¶é—´ã€ç»“æŸæ—¶é—´ï¼Œæ›´æ–°æœºå™¨å’Œå·¥ä»¶å®Œæˆæ—¶é—´ã€‚
            self._schedule_operation(
                job_id,  # å½“å‰æ“ä½œæ‰€å±çš„å·¥ä»¶IDã€‚
                job_need,
                op_id,  # å½“å‰æ“ä½œåœ¨å·¥ä»¶ä¸­çš„æ“ä½œIDã€‚
                op,  # å½“å‰æ“ä½œå¯¹è±¡ã€‚
                self.job_finished_times,  # å·¥ä»¶å®Œæˆæ—¶é—´è®°å½•ã€‚
                machines_finished_times,  # æœºå™¨å®Œæˆæ—¶é—´è®°å½•ã€‚
                prev_time_assembly,  # è£…é…æ“ä½œçš„ä¾èµ–å®Œæˆæ—¶é—´ã€‚
                machine_selection,  # æœºå™¨é€‰æ‹©ç­–ç•¥ã€‚
                if_allow_forward  # æ˜¯å¦å‰ç§»ï¼Œä¸»åŠ¨æˆ–è€…å…¨ä¸»åŠ¨ä¼šç”¨
            )
            # if op_index > 115:
            #     plot_gantt_chart(self.jobs, self.machines, "active")
            #     print()
        idle_list = get_whole_machine_idle_times(machines_finished_times)
        # ğŸˆ è®¡ç®—æ¯å°æœºå™¨çš„ç©ºé—²æ—¶é—´æ€»é•¿åº¦
        # è·å–æ¯å°æœºå™¨çš„ç©ºé—²æ—¶é—´æ®µï¼ˆstart, endï¼‰åˆ—è¡¨ï¼Œéå†è®¡ç®—æ€»çš„ç©ºé—²æ—¶é—´ã€‚
        idle_durations = []
        for i, machine in enumerate(idle_list):
            total_idle_time = 0
            for start, end in machine:
                total_idle_time += end - start  # è®¡ç®—æ¯ä¸ªç©ºé—²æ—¶é—´æ®µçš„æŒç»­æ—¶é—´
            idle_durations.append(total_idle_time)

        # ğŸˆ è®¡ç®—ç©ºé—²èƒ½è€—
        # éå†æ¯å°æœºå™¨ï¼Œæ ¹æ®å…¶ç©ºé—²æ—¶é—´é•¿åº¦å’Œç©ºé—²åŠŸç‡ï¼Œè®¡ç®—ç©ºé—²èƒ½è€—ã€‚
        for i in range(len(idle_durations)):
            idle_power = self.get_idle_power_by_machine(i + 1)  # è·å–ç¬¬ i+1 å°æœºå™¨çš„ç©ºé—²åŠŸç‡
            idle_energy = idle_power * idle_durations[i]  # ç©ºé—²èƒ½è€— = ç©ºé—²åŠŸç‡ * ç©ºé—²æ—¶é—´
            self.machines_idle_energy_usage[i] = idle_energy  # æ›´æ–°å¯¹åº”æœºå™¨çš„ç©ºé—²èƒ½è€—è®°å½•
        # è·å–æ¯ä¸ªä½œä¸šçš„å»¶è¿Ÿæ—¶é—´
        job_delay_time = get_job_delay_times(self.job_finished_times)

        # éå†æ¯ä¸ªä½œä¸šçš„å»¶è¿Ÿæ—¶é—´
        for i, job in enumerate(job_delay_time):
            total_idle_time = 0  # åˆå§‹åŒ–å½“å‰ä½œä¸šçš„æ€»ç©ºé—²æ—¶é—´
            # éå†ä½œä¸šçš„æ¯ä¸ªç©ºé—²æ—¶é—´æ®µ
            for start, end in job:
                total_idle_time += end - start  # è®¡ç®—æ¯ä¸ªç©ºé—²æ—¶é—´æ®µçš„æŒç»­æ—¶é—´ï¼Œå¹¶ç´¯åŠ åˆ°æ€»ç©ºé—²æ—¶é—´
            # å°†å½“å‰ä½œä¸šçš„æ€»ç©ºé—²æ—¶é—´æ·»åŠ åˆ°å»¶è¿Ÿæ—¶é—´åˆ—è¡¨ä¸­
            self.job_delay_time.append(total_idle_time)
        # print()

    def get_assembly_jobs(self, assembly_selection):
        """
        æ ¹æ®ç»™å®šçš„è£…é…ä»»åŠ¡é€‰æ‹©ï¼Œæ›´æ–°å¹¶è¿”å›ä¸€ä¸ªæ–°çš„äºŒç»´æ•°ç»„ï¼Œè¡¨ç¤ºæ¯ä¸ªæ ·å¼çš„ä»»åŠ¡ç¼–å·ã€‚

        :param assembly_selection: ä¸€ä¸ªåˆ—è¡¨ï¼ŒåŒ…å«é€‰æ‹©çš„ä»»åŠ¡ç´¢å¼•ï¼Œè¡¨ç¤ºå°†è¦åˆ†é…çš„ä»»åŠ¡ã€‚
        :return: ä¸€ä¸ªäºŒç»´åˆ—è¡¨ï¼ŒåŒ…å«ä»»åŠ¡ç¼–å·çš„åˆ†é…æƒ…å†µã€‚æ¯ä¸ªä½ç½®å¦‚æœæ‰¾åˆ°åŒ¹é…çš„ä»»åŠ¡ï¼Œ
                 åˆ™å­˜å‚¨ä»»åŠ¡çš„ç´¢å¼•ï¼›å¦åˆ™ä¸º -1ï¼Œè¡¨ç¤ºæ²¡æœ‰ä»»åŠ¡åŒ¹é…è¯¥ä½ç½®çš„æ ·å¼éœ€æ±‚ã€‚
        """
        # åˆ›å»ºä¸€ä¸ªä¸ self.need_styles ç»“æ„ç›¸åŒçš„äºŒç»´æ•°ç»„ï¼Œåˆå§‹å€¼ä¸º -1
        ret = [[-1 for _ in row] for row in self.need_styles]

        # éå†è£…é…é€‰æ‹©çš„ä»»åŠ¡
        for job_index in assembly_selection:
            job = self.jobs[job_index]  # è·å–å½“å‰ä»»åŠ¡å¯¹è±¡
            flag = False  # æ ‡å¿—ä½ï¼Œç”¨äºæ ‡è®°ä»»åŠ¡æ˜¯å¦å·²ç»æˆåŠŸåŒ¹é…

            # éå†æ‰€æœ‰æ ·å¼éœ€æ±‚çš„äºŒç»´æ•°ç»„
            for i, styles in enumerate(self.need_styles):
                for j, style in enumerate(styles):
                    # å¦‚æœå½“å‰éœ€è¦çš„ä½ç½®è¿˜æ²¡æœ‰è¢«å¡«å……ï¼Œå¹¶ä¸”è¯¥æ ·å¼ä¸å½“å‰ä»»åŠ¡æ ·å¼åŒ¹é…
                    if ret[i][j] == -1 and self.need_styles[i][j] == job.style:
                        ret[i][j] = job_index + 1  # å°†è¯¥ä½ç½®æ›´æ–°ä¸ºä»»åŠ¡çš„ç´¢å¼•
                        flag = True  # è®¾ç½®æ ‡å¿—ä½ï¼Œè¡¨ç¤ºä»»åŠ¡å·²ç»åŒ¹é…æˆåŠŸ
                        break  # è·³å‡ºå†…å±‚å¾ªç¯ï¼Œç»§ç»­æ£€æŸ¥ä¸‹ä¸€ä¸ªä»»åŠ¡
                if flag:
                    break  # å¦‚æœä»»åŠ¡åŒ¹é…æˆåŠŸï¼Œè·³å‡ºå¤–å±‚å¾ªç¯ï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ªä»»åŠ¡

        return ret  # è¿”å›æ›´æ–°åçš„ä»»åŠ¡åˆ†é…æƒ…å†µ

    # ç›®æ ‡å‡½æ•°è®¡ç®—
    def calculate_makespan(self):
        """
        è®¡ç®— fitness functionï¼ˆæœ€åä¸€é“å·¥åºçš„ç»“æŸæ—¶é—´ï¼‰ã€‚
        """
        if not self.job_finished_times:
            raise ValueError("è°ƒåº¦å°šæœªè¿è¡Œï¼Œjob_finished_times ä¸ºç©ºã€‚è¯·å…ˆè¿è¡Œè°ƒåº¦æ–¹æ³•ã€‚")

        # è·å–æ¯ä¸ªå·¥ä»¶çš„æœ€åå®Œæˆæ—¶é—´
        last_time = max(times[-1][1] for times in self.job_finished_times if times)
        return last_time

    def calculate_running_energy_usage(self):
        """
        è®¡ç®—æ‰€æœ‰æœºå™¨çš„æ€»èƒ½é‡æ¶ˆè€—ã€‚

        Returns:
            list: æ¯å°æœºå™¨çš„æ€»èƒ½é‡æ¶ˆè€—ã€‚
        """
        return self.machines_energy_usage

    def calculate_idle_energy_usage(self):
        """
        è®¡ç®—æ‰€æœ‰æœºå™¨åœ¨ç©ºé—²çŠ¶æ€ä¸‹çš„æ€»èƒ½è€—ã€‚

        è¯¥æ–¹æ³•ä» `machines_idle_energy_usage` å±æ€§ä¸­è·å–æœºå™¨åœ¨ç©ºé—²çŠ¶æ€ä¸‹çš„èƒ½è€—æŒ‡æ ‡ï¼Œ
        å¹¶è¿”å›æ€»çš„ç©ºé—²èƒ½è€—ã€‚

        è¿”å›å€¼:
            float: æ‰€æœ‰æœºå™¨åœ¨ç©ºé—²æ—¶é—´çš„æ€»èƒ½è€—ã€‚
        """
        return self.machines_idle_energy_usage

    def calculate_job_delay_time(self):
        """
        è®¡ç®—æ‰€æœ‰ä½œä¸šçš„æ€»å»¶è¿Ÿæ—¶é—´ã€‚

        è¯¥æ–¹æ³•åŸºäº `job_delay_time` å±æ€§ï¼Œè¿”å›æ‰€æœ‰ä½œä¸šçš„ç´¯è®¡å»¶è¿Ÿæ—¶é—´ã€‚

        è¿”å›å€¼:
            float: æ‰€æœ‰ä½œä¸šçš„æ€»å»¶è¿Ÿæ—¶é—´ã€‚
        """
        return self.job_delay_time

    def run_fully_active_schedule(self):
        """
        å…¨ä¸»åŠ¨è°ƒåº¦ï¼šåŠ¨æ€é€‰æ‹©æ“ä½œå’Œæœºå™¨ï¼Œè¿›è¡Œå…¨å±€ä¼˜åŒ–ã€‚
        """
        pass

    def _initialize_assembly_queue(self):
        """
        ğŸ› ï¸ åˆå§‹åŒ–è£…é…é˜Ÿåˆ— ğŸ› ï¸

        åŠŸèƒ½ï¼š
        - åˆ›å»ºä¸€ä¸ªè£…é…é˜Ÿåˆ—å­—å…¸ï¼Œç”¨äºç®¡ç†è£…é…æ“ä½œçš„å·¥ä»¶ç­‰å¾…é˜Ÿåˆ—ã€‚
        - è£…é…é˜Ÿåˆ—çš„æ¯ä¸ªé”®æ˜¯å·¥ä»¶ç±»å‹ï¼ˆç”±è£…é…è§„åˆ™å®šä¹‰ï¼‰ï¼Œ
          å€¼æ˜¯ä¸€ä¸ªåŒç«¯é˜Ÿåˆ—ï¼ˆdequeï¼‰ï¼Œç”¨äºå­˜å‚¨ç­‰å¾…è£…é…çš„å·¥ä»¶ã€‚

        è®¾è®¡ç›®çš„ï¼š
        - æ”¯æŒè£…é…æ“ä½œæ—¶ä¸åŒå·¥ä»¶ç±»å‹çš„ç®¡ç†å’Œé…å¯¹éœ€æ±‚ã€‚
        - ä¿è¯æ¯ç§å·¥ä»¶ç±»å‹åœ¨è£…é…é˜Ÿåˆ—ä¸­éƒ½æœ‰å¯¹åº”çš„é˜Ÿåˆ—ï¼Œå³ä½¿åˆå§‹ä¸ºç©ºã€‚

        Returns:
            dict: åŒ…å«æ‰€æœ‰å·¥ä»¶ç±»å‹åŠå…¶ç­‰å¾…é˜Ÿåˆ—çš„è£…é…é˜Ÿåˆ—å­—å…¸ã€‚
        """

        # ğŸˆ åˆ›å»ºä¸€ä¸ªç©ºå­—å…¸ï¼Œç”¨äºå­˜å‚¨è£…é…é˜Ÿåˆ—
        # é”®ï¼ˆkeyï¼‰ï¼šå·¥ä»¶ç±»å‹ï¼ˆå¦‚param1æˆ–param2ï¼‰
        # å€¼ï¼ˆvalueï¼‰ï¼šè¯¥å·¥ä»¶ç±»å‹çš„åŒç«¯é˜Ÿåˆ—ï¼ˆdequeï¼‰
        assembly_queue = {}

        # ğŸˆ éå†è£…é…è§„åˆ™ï¼Œä¾æ¬¡å¤„ç†æ¯ä¸ªè£…é…éœ€æ±‚
        # - æ¯ä¸ªè£…é…è§„åˆ™å®šä¹‰äº†ä¸¤ç§éœ€è¦é…å¯¹çš„å·¥ä»¶ç±»å‹ï¼šparam1 å’Œ param2
        for style in self.assemble_styles:
            # ğŸ’™ ç¡®ä¿å­—å…¸ä¸­å­˜åœ¨param1ã€2å¯¹åº”çš„é˜Ÿåˆ—ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™åˆ›å»ºä¸€ä¸ªç©ºé˜Ÿåˆ—
            assembly_queue.setdefault(style.param1, deque())
            assembly_queue.setdefault(style.param2, deque())

        # ğŸˆ è¿”å›è£…é…é˜Ÿåˆ—å­—å…¸
        # å­—å…¸çš„æ ¼å¼ä¸ºï¼š
        # {
        #     å·¥ä»¶ç±»å‹1: deque([...]),
        #     å·¥ä»¶ç±»å‹2: deque([...]),
        #     ...
        # }
        return assembly_queue

    def _schedule_operation(self, job_id, job_need, op_id, op, job_finished_times, machines_finished_times,
                            prev_time_assembly,
                            machine_selection, if_allow_forward):
        """
        ğŸ› ï¸ è°ƒåº¦å•ä¸ªæ“ä½œ ğŸ› ï¸

        åŠŸèƒ½ï¼š
        - è´Ÿè´£è°ƒåº¦å•ä¸ªæ“ä½œï¼ˆoperationï¼‰ï¼Œè®¡ç®—å…¶å¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´ã€‚
        - æ ¹æ®å·¥ä»¶å’Œæœºå™¨çš„å®Œæˆæ—¶é—´æ›´æ–°æ“ä½œçš„è°ƒåº¦çŠ¶æ€ã€‚
        - æ›´æ–°å·¥ä»¶å’Œæœºå™¨çš„å®Œæˆæ—¶é—´åˆ—è¡¨ï¼Œç¡®ä¿ä¸‹ä¸€æ“ä½œèƒ½å¤Ÿæ­£ç¡®æ¨å¯¼ã€‚

        è°ƒåº¦é€»è¾‘ï¼š
        1. è·å–å½“å‰æ“ä½œçš„å…¨å±€ç´¢å¼•ï¼Œç¡®å®šå…¶å¯¹åº”çš„æœºå™¨ã€‚
        2. æ ¹æ®é€‰æ‹©çš„æœºå™¨ï¼Œè·å–è¯¥æœºå™¨çš„å¤„ç†æ—¶é—´ã€‚
        3. è®¡ç®—æ“ä½œçš„å¼€å§‹æ—¶é—´ï¼š
            - æ»¡è¶³å·¥ä»¶çš„å‰åºæ“ä½œå®Œæˆæ—¶é—´ã€‚
            - æ»¡è¶³æ‰€é€‰æœºå™¨çš„æœ€æ—©ç©ºé—²æ—¶é—´ã€‚
            - æ»¡è¶³è£…é…ä¾èµ–æ¡ä»¶ï¼ˆå¦‚æœæœ‰è£…é…æ“ä½œï¼‰ã€‚
        4. æ ¹æ®å¼€å§‹æ—¶é—´å’Œå¤„ç†æ—¶é—´ï¼Œè®¡ç®—æ“ä½œçš„ç»“æŸæ—¶é—´ã€‚
        5. æ›´æ–°å®Œæˆæ—¶é—´è®°å½•ï¼š
            - æ›´æ–°å·¥ä»¶å®Œæˆæ—¶é—´åˆ—è¡¨ï¼ˆjob_finished_timesï¼‰ã€‚
            - æ›´æ–°æœºå™¨å®Œæˆæ—¶é—´åˆ—è¡¨ï¼ˆmachine_finished_timesï¼‰ã€‚
        6. è°ƒç”¨æ“ä½œçš„æ›´æ–°æ–¹æ³•ï¼Œè®°å½•è°ƒåº¦ç»“æœã€‚

        Args:
            job_id (int): å½“å‰æ“ä½œæ‰€å±å·¥ä»¶çš„IDã€‚
            op_id (int): å½“å‰æ“ä½œåœ¨å·¥ä»¶ä¸­çš„æ“ä½œIDã€‚
            op (Operation): å½“å‰æ“ä½œå¯¹è±¡ï¼ŒåŒ…å«æ“ä½œçš„è¯¦ç»†ä¿¡æ¯ã€‚
            job_finished_times (list): å·¥ä»¶å®Œæˆæ—¶é—´è®°å½•ï¼Œæ¯ä¸ªå·¥ä»¶æœ‰ç‹¬ç«‹çš„å®Œæˆæ—¶é—´åˆ—è¡¨ã€‚
            machines_finished_times (list): æœºå™¨å®Œæˆæ—¶é—´è®°å½•ï¼Œæ¯å°æœºå™¨æœ‰ç‹¬ç«‹çš„å®Œæˆæ—¶é—´åˆ—è¡¨ã€‚
            prev_time_assembly (int): è£…é…ä¾èµ–å®Œæˆæ—¶é—´ï¼Œé»˜è®¤ä¸º -1 è¡¨ç¤ºæ— è£…é…ä¾èµ–ã€‚
            machine_selection (list): æœºå™¨é€‰æ‹©ç­–ç•¥ï¼Œä¸ºæ¯ä¸ªæ“ä½œé€‰æ‹©å¯¹åº”çš„æœºå™¨ç´¢å¼•ã€‚

        Returns:
            None
        """
        # ğŸˆ è·å–å½“å‰æ“ä½œçš„å…¨å±€ç´¢å¼•
        # å…¨å±€ç´¢å¼•é€šè¿‡å·¥ä»¶IDå’Œæ“ä½œIDæ¨å¯¼ï¼Œè¡¨ç¤ºåœ¨å…¨å±€è°ƒåº¦é¡ºåºä¸­çš„ä½ç½®
        op_global_index = self.get_op_index(job_id, op_id)

        # ğŸˆ æ ¹æ®å…¨å±€ç´¢å¼•è·å–å½“å‰æ“ä½œçš„æœºå™¨ç´¢å¼•
        # ä»æœºå™¨é€‰æ‹©ç­–ç•¥ä¸­è·å–å½“å‰æ“ä½œåˆ†é…çš„æœºå™¨ç´¢å¼•
        machine_index = machine_selection[op_global_index]

        # ğŸˆ ç¡®å®šå½“å‰æ“ä½œåˆ†é…çš„æœºå™¨
        # `available_machines` å­˜å‚¨äº†å½“å‰æ“ä½œå¯ä»¥ä½¿ç”¨çš„æ‰€æœ‰æœºå™¨
        # é€‰æ‹©çš„æœºå™¨ç”±æœºå™¨ç´¢å¼•å†³å®š
        machine = op.available_machines[machine_index][0]

        # ğŸˆ è·å–å½“å‰æ“ä½œåœ¨æŒ‡å®šæœºå™¨ä¸Šçš„å¤„ç†æ—¶é—´
        # ä¸åŒæœºå™¨å¯èƒ½å…·æœ‰ä¸åŒçš„å¤„ç†æ—¶é—´
        processing_time = op.get_processing_time_by_machine(machine)
        # æ±‚æœºå™¨åŠ å·¥è¿‡ç¨‹æ¶ˆè€—çš„èƒ½é‡
        energy_used = self.get_run_power_by_machine(machine) * processing_time

        # ğŸˆ è·å–å½“å‰å·¥ä»¶çš„ä¸Šä¸€ä¸ªæ“ä½œçš„å®Œæˆæ—¶é—´
        # job_finished_times[job_id - 1][-1] è¡¨ç¤ºè¯¥å·¥ä»¶çš„æœ€æ–°å®Œæˆæ—¶é—´
        prev_time_job = job_finished_times[job_id - 1][-1][1]

        # ğŸˆ è·å–å½“å‰æœºå™¨çš„æœ€è¿‘å®Œæˆæ—¶é—´
        # machines_finished_times[machine - 1][-1] è¡¨ç¤ºè¯¥æœºå™¨çš„æœ€æ–°å®Œæˆæ—¶é—´
        prev_time_machine = get_machine_available_time(if_allow_forward, machines_finished_times[machine - 1],
                                                       prev_time_job,
                                                       prev_time_assembly,
                                                       processing_time)

        # ğŸˆ è®¡ç®—æ“ä½œçš„å¼€å§‹æ—¶é—´
        # å¼€å§‹æ—¶é—´éœ€è¦æ»¡è¶³ä»¥ä¸‹æ¡ä»¶ï¼š
        # 1. å·¥ä»¶çš„å‰åºæ“ä½œå®Œæˆæ—¶é—´ï¼ˆprev_time_jobï¼‰ã€‚
        # 2. å½“å‰æœºå™¨çš„æœ€æ—©ç©ºé—²æ—¶é—´ï¼ˆprev_time_machineï¼‰ã€‚
        # 3. è£…é…æ¡ä»¶å®Œæˆæ—¶é—´ï¼ˆprev_time_assemblyï¼‰ã€‚
        start_time = max(prev_time_job, prev_time_machine, prev_time_assembly)

        # ğŸˆ è®¡ç®—æ“ä½œçš„ç»“æŸæ—¶é—´
        # ç»“æŸæ—¶é—´ = å¼€å§‹æ—¶é—´ + å½“å‰æ“ä½œçš„å¤„ç†æ—¶é—´
        end_time = start_time + processing_time

        # ğŸˆ æ›´æ–°å·¥ä»¶å®Œæˆæ—¶é—´è®°å½•
        # å°†å½“å‰æ“ä½œçš„å®Œæˆæ—¶é—´è®°å½•åˆ°å¯¹åº”çš„å·¥ä»¶å®Œæˆæ—¶é—´åˆ—è¡¨ä¸­

        if job_need is not None:
            # èƒ½è£…é…
            for job in job_need.assembly_jobs:
                job_finished_times[job.id - 1].append((start_time, end_time))
        else:
            # ä¸èƒ½è£…é…
            job_finished_times[job_id - 1].append((start_time, end_time))

        # ğŸˆ æ›´æ–°æœºå™¨å®Œæˆæ—¶é—´è®°å½•
        # å°†å½“å‰æ“ä½œçš„å®Œæˆæ—¶é—´è®°å½•åˆ°å¯¹åº”çš„æœºå™¨å®Œæˆæ—¶é—´åˆ—è¡¨ä¸­
        machines_finished_times[machine - 1].append((start_time, end_time))
        machines_finished_times[machine - 1].sort(key=lambda x: x[0])

        # ğŸˆ ç´¯åŠ èƒ½é‡æ¶ˆè€—åˆ°å¯¹åº”æœºå™¨
        self.machines_energy_usage[machine - 1] += energy_used

        # ğŸˆ è°ƒç”¨æ“ä½œçš„æ›´æ–°æ–¹æ³•
        # æ›´æ–°æ“ä½œå¯¹è±¡çš„è°ƒåº¦ä¿¡æ¯ï¼Œè®°å½•åˆ†é…çš„æœºå™¨ã€å¼€å§‹æ—¶é—´å’Œç»“æŸæ—¶é—´
        op.update(machine, start_time, end_time)

    def get_op_index(self, job_id, op_id):
        """
        è·å–å…¨å±€æ“ä½œç´¢å¼•ã€‚

        åŠŸèƒ½ï¼š
        - è®¡ç®—æŸä¸ªæ“ä½œåœ¨å…¨å±€æ“ä½œåˆ—è¡¨ä¸­çš„ç´¢å¼•ã€‚
        - ç´¢å¼•æ˜¯åŸºäºæ‰€æœ‰å·¥ä»¶çš„æ“ä½œæ€»å’Œï¼ŒæŒ‰å·¥ä»¶é¡ºåºç´¯åŠ è®¡ç®—çš„ã€‚

        è°ƒåº¦èƒŒæ™¯ï¼š
        - è°ƒåº¦ä¸­éœ€è¦æ ¹æ®å…¨å±€ç´¢å¼•æ¥é€‰æ‹©æœºå™¨å’Œæ“ä½œï¼Œè€Œæ“ä½œç´¢å¼•æ˜¯æŒ‰ç…§å·¥ä»¶çš„æ“ä½œé¡ºåºæ¥æ¨å¯¼çš„ã€‚

        è®¡ç®—é€»è¾‘ï¼š
        - éå† `self.jobs` ä¸­ä»ç¬¬ 1 ä¸ªå·¥ä»¶åˆ°å½“å‰å·¥ä»¶ï¼ˆ`job_id - 1`ï¼‰çš„æ‰€æœ‰æ“ä½œæ•°é‡ã€‚
        - å°†è¿™äº›æ“ä½œæ•°é‡ç›¸åŠ ï¼Œå¾—åˆ°å½“å‰å·¥ä»¶ä¹‹å‰æ‰€æœ‰æ“ä½œçš„æ€»æ•°ã€‚
        - åŠ ä¸Šå½“å‰å·¥ä»¶çš„ `op_id`ï¼ˆå½“å‰å·¥ä»¶çš„ç¬¬å‡ ä¸ªæ“ä½œï¼‰å¹¶å‡å» 1ï¼Œå¾—åˆ°å…¨å±€ç´¢å¼•ã€‚

        Args:
            job_id (int): å·¥ä»¶IDï¼Œä»1å¼€å§‹ç¼–å·ã€‚
            op_id (int): æ“ä½œIDï¼Œä»1å¼€å§‹ç¼–å·ï¼Œè¡¨ç¤ºå·¥ä»¶ä¸­çš„ç¬¬å‡ ä¸ªæ“ä½œã€‚

        Returns:
            int: å…¨å±€æ“ä½œç´¢å¼•ï¼Œè¡¨ç¤ºè¯¥æ“ä½œåœ¨æ‰€æœ‰å·¥ä»¶çš„æ“ä½œåˆ—è¡¨ä¸­çš„ä½ç½®ï¼ˆä»0å¼€å§‹è®¡æ•°ï¼‰ã€‚
        """
        # ğŸˆ éå†ä»ç¬¬ 1 ä¸ªå·¥ä»¶åˆ°å½“å‰å·¥ä»¶ï¼ˆjob_id - 1ï¼‰ä¹‹å‰çš„æ‰€æœ‰å·¥ä»¶
        # ä½¿ç”¨ job.get_num_ops() è·å–æ¯ä¸ªå·¥ä»¶çš„æ“ä½œæ•°é‡ï¼Œç´¯åŠ å¾—åˆ°æ€»æ“ä½œæ•°
        num_previous_ops = sum(job.get_num_ops() for job in self.jobs[:job_id - 1])

        # ğŸˆ åŠ ä¸Šå½“å‰å·¥ä»¶çš„æ“ä½œIDï¼ˆop_idï¼‰ï¼Œå†å‡å» 1ï¼Œå¾—åˆ°å…¨å±€ç´¢å¼•
        global_op_index = num_previous_ops + op_id - 1

        # ğŸˆ è¿”å›è®¡ç®—åçš„å…¨å±€ç´¢å¼•
        return global_op_index

    def sequence_operations_by_job(self, job_sequence):
        """
        æ ¹æ®é¡ºåºè¿”å›å·¥ä»¶IDã€‚

        åŠŸèƒ½ï¼š
        - æ ¹æ®è¾“å…¥çš„å…¨å±€æ“ä½œç´¢å¼•åºåˆ—ï¼ˆ`job_sequence`ï¼‰ï¼Œè¿”å›å¯¹åº”çš„å·¥ä»¶IDåˆ—è¡¨ã€‚
        - è¯¥æ–¹æ³•å°†æ‰€æœ‰æ“ä½œæŒ‰å·¥ä»¶æ‹†è§£ï¼Œä»¥ä¾¿é€ä¸ªå·¥ä»¶å¤„ç†è°ƒåº¦ã€‚

        è°ƒåº¦èƒŒæ™¯ï¼š
        - åœ¨è°ƒåº¦ç®—æ³•ä¸­ï¼Œæ“ä½œè°ƒåº¦éœ€è¦æ˜ å°„åˆ°å…·ä½“çš„å·¥ä»¶ã€‚è¯¥æ–¹æ³•ç”¨äºå°†å…¨å±€ç´¢å¼•æ˜ å°„ä¸ºå·¥ä»¶IDã€‚

        å®ç°é€»è¾‘ï¼š
        - éå†æ‰€æœ‰å·¥ä»¶çš„æ“ä½œåˆ—è¡¨ï¼Œæå–æ¯ä¸ªæ“ä½œå¯¹åº”çš„å·¥ä»¶IDï¼Œå½¢æˆå…¨å±€æ“ä½œåˆ°å·¥ä»¶IDçš„æ˜ å°„è¡¨ã€‚
        - æŒ‰ç…§ `job_sequence` ä¸­çš„é¡ºåºï¼ŒæŸ¥æ‰¾å¯¹åº”çš„å·¥ä»¶IDï¼Œç”Ÿæˆå·¥ä»¶IDåˆ—è¡¨ã€‚

        Args:
            job_sequence (list): æ“ä½œé¡ºåºåˆ—è¡¨ï¼Œæ¯ä¸ªå…ƒç´ æ˜¯å…¨å±€æ“ä½œçš„ç´¢å¼•ã€‚

        Returns:
            list: å·¥ä»¶IDé¡ºåºï¼Œè¡¨ç¤ºæ¯ä¸ªå…¨å±€æ“ä½œç´¢å¼•å¯¹åº”çš„å·¥ä»¶IDã€‚
        """
        # ğŸˆ éå†æ‰€æœ‰å·¥ä»¶çš„æ“ä½œï¼Œç”Ÿæˆå…¨å±€æ“ä½œç´¢å¼•å¯¹åº”çš„å·¥ä»¶IDåˆ—è¡¨
        # operation_job_ids æ˜¯ä¸€ä¸ªé•¿åº¦ä¸ºæ‰€æœ‰æ“ä½œæ•°çš„åˆ—è¡¨ï¼Œå­˜å‚¨äº†æ¯ä¸ªæ“ä½œçš„å·¥ä»¶ID
        operation_job_ids = [operation.job_id for job in self.jobs for operation in job.ops]

        # ğŸˆ æ ¹æ® `job_sequence` ä¸­çš„å…¨å±€æ“ä½œç´¢å¼•ï¼ŒæŸ¥æ‰¾å¯¹åº”çš„å·¥ä»¶ID
        # å°† `job_sequence` è½¬æ¢ä¸ºå·¥ä»¶IDåˆ—è¡¨
        job_id_sequence = [operation_job_ids[index] for index in job_sequence]

        # ğŸˆ è¿”å›å·¥ä»¶IDé¡ºåºåˆ—è¡¨
        return job_id_sequence

    def _can_assemble(self, job, op, assembly_queue, job_finished_times):
        """
        æ£€æŸ¥æ˜¯å¦æ»¡è¶³è£…é…æ¡ä»¶ã€‚

        åŠŸèƒ½ï¼š
        - åˆ¤æ–­å½“å‰æ“ä½œæ˜¯å¦å¯ä»¥ä½œä¸ºè£…é…æ“ä½œæ‰§è¡Œã€‚
        - æ£€æŸ¥å½“å‰å·¥ä»¶æ˜¯å¦æ»¡è¶³è£…é…è§„åˆ™çš„ä¾èµ–æ¡ä»¶ã€‚
        - å¦‚æœè£…é…æ¡ä»¶æ»¡è¶³ï¼Œåˆ™å®Œæˆè£…é…ï¼Œå¹¶æ›´æ–°æ“ä½œä¿¡æ¯ã€‚
        - å¦‚æœè£…é…æ¡ä»¶ä¸æ»¡è¶³ï¼Œåˆ™å°†å½“å‰å·¥ä»¶åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ã€‚

        é€»è¾‘ï¼š
        1. ä»å½“å‰æ“ä½œçš„è£…é…è§„åˆ™ä¸­è·å–é…å¯¹æ‰€éœ€çš„ä¸¤ç§å·¥ä»¶ç±»å‹ï¼ˆparam1 å’Œ param2ï¼‰ã€‚
        2. æ ¹æ®å½“å‰å·¥ä»¶çš„ç±»å‹ï¼Œåˆ¤æ–­éœ€è¦çš„å¦ä¸€ç§å·¥ä»¶ç±»å‹ã€‚
        3. æ£€æŸ¥è£…é…é˜Ÿåˆ—ä¸­æ˜¯å¦å­˜åœ¨æ‰€éœ€çš„å¦ä¸€ç§å·¥ä»¶ï¼š
            - å¦‚æœå­˜åœ¨ï¼Œä»é˜Ÿåˆ—ä¸­å–å‡ºè¯¥å·¥ä»¶ï¼Œå®Œæˆè£…é…æ“ä½œï¼Œå¹¶æ›´æ–°ç›¸å…³ä¿¡æ¯ã€‚
            - å¦‚æœä¸å­˜åœ¨ï¼Œå°†å½“å‰å·¥ä»¶åŠ å…¥ç­‰å¾…é˜Ÿåˆ—ï¼Œå¹¶è¿”å› -1 è¡¨ç¤ºè£…é…æ¡ä»¶ä¸æ»¡è¶³ã€‚

        Args:
            job (Job): å½“å‰å·¥ä»¶å¯¹è±¡ï¼Œè¡¨ç¤ºå½“å‰éœ€è¦åˆ¤æ–­çš„å·¥ä»¶ã€‚
            op (Operation): å½“å‰æ“ä½œå¯¹è±¡ï¼Œè¡¨ç¤ºéœ€è¦è°ƒåº¦çš„æ“ä½œã€‚
            assembly_queue (dict): è£…é…é˜Ÿåˆ—ï¼Œç”¨äºç®¡ç†ä¸åŒç±»å‹å·¥ä»¶çš„ç­‰å¾…é˜Ÿåˆ—ã€‚
                                   é”®ä¸ºå·¥ä»¶ç±»å‹ï¼Œå€¼ä¸ºè¯¥ç±»å‹å·¥ä»¶çš„åŒç«¯é˜Ÿåˆ—ã€‚
            job_finished_times (list): å·¥ä»¶å®Œæˆæ—¶é—´è®°å½•ï¼Œæ¯ä¸ªå·¥ä»¶çš„å®Œæˆæ—¶é—´åˆ—è¡¨ã€‚

        Returns:
            int: å¦‚æœè£…é…æ¡ä»¶æ»¡è¶³ï¼Œè¿”å›æ‰€éœ€å·¥ä»¶çš„å®Œæˆæ—¶é—´ï¼›å¦‚æœä¸æ»¡è¶³ï¼Œè¿”å› -1ã€‚
        """
        # ğŸˆ è·å–å½“å‰æ“ä½œçš„è£…é…è§„åˆ™
        # æ¯ä¸ªè£…é…æ“ä½œéƒ½æœ‰ç‰¹å®šçš„è£…é…è§„åˆ™ï¼ˆassemble_styleï¼‰ï¼Œå®šä¹‰éœ€è¦é…å¯¹çš„å·¥ä»¶ç±»å‹
        cur_assemble_style = op.assemble_style

        # ğŸˆ è·å–å½“å‰å·¥ä»¶çš„ç±»å‹
        # å·¥ä»¶ç±»å‹å†³å®šäº†å½“å‰å·¥ä»¶æ˜¯è£…é…è§„åˆ™ä¸­çš„å“ªç§ç±»å‹ï¼ˆparam1 æˆ– param2ï¼‰
        job_style = job.style

        # ğŸˆ ä»è£…é…è§„åˆ™ä¸­è·å–æ‰€éœ€çš„ä¸¤ç§å·¥ä»¶ç±»å‹
        # param1 å’Œ param2 æ˜¯éœ€è¦é…å¯¹çš„å·¥ä»¶ç±»å‹
        param1 = cur_assemble_style.param1
        param2 = cur_assemble_style.param2

        # ğŸˆ ç¡®å®šæ‰€éœ€çš„å¦ä¸€ç§å·¥ä»¶ç±»å‹
        # å¦‚æœå½“å‰å·¥ä»¶çš„ç±»å‹æ˜¯ param1ï¼Œåˆ™éœ€è¦å¦ä¸€ç§ç±»å‹ä¸º param2ï¼Œåä¹‹äº¦ç„¶
        param = param2 if job_style == param1 else param1

        # ğŸˆ å°è¯•è·å–å½“å‰å·¥ä»¶ç±»å‹çš„é˜Ÿåˆ—
        # å¦‚æœé˜Ÿåˆ—ä¸å­˜åœ¨ï¼Œåˆ™åˆ›å»ºä¸€ä¸ªç©ºé˜Ÿåˆ—ï¼ˆé˜²æ­¢ KeyErrorï¼‰
        try:
            deque_self = assembly_queue[job_style]
        except KeyError:
            deque_self = deque()  # å¦‚æœå½“å‰å·¥ä»¶ç±»å‹é˜Ÿåˆ—ä¸å­˜åœ¨ï¼Œåˆ™åˆå§‹åŒ–ä¸ºç©º

        # ğŸˆ è·å–æ‰€éœ€çš„å¦ä¸€ç§å·¥ä»¶ç±»å‹çš„é˜Ÿåˆ—
        deque_need = assembly_queue[param]

        # ğŸˆ æ£€æŸ¥æ‰€éœ€å·¥ä»¶é˜Ÿåˆ—æ˜¯å¦ä¸ºç©º
        # å¦‚æœæ‰€éœ€å·¥ä»¶çš„é˜Ÿåˆ—ä¸ºç©ºï¼Œåˆ™å°†å½“å‰å·¥ä»¶åŠ å…¥è‡ªèº«é˜Ÿåˆ—ï¼Œå¹¶è¿”å› -1
        if not deque_need:
            # å¦‚æœå½“å‰å·¥ä»¶å°šæœªåœ¨è‡ªèº«é˜Ÿåˆ—ä¸­ï¼Œåˆ™å°†å…¶åŠ å…¥ç­‰å¾…é˜Ÿåˆ—
            # if job not in deque_self :
            #     deque_self.append(job)
            if job not in deque_self and all(assembly_job not in deque_self for assembly_job in job.assembly_jobs):
                deque_self.append(job)

            return -1, None

        list_need = []
        for jobs in self.assemble_jobs:
            if job.id in jobs:
                for job_id in jobs:
                    list_need.append(self.jobs[job_id - 1])
                break

        if set(list_need) & set(deque_need):  # æˆ–è€…ä½¿ç”¨ .intersection() æ–¹æ³•
            job_need = next(iter(set(list_need) & set(deque_need)))
        else:
            if job not in deque_self and all(assembly_job not in deque_self for assembly_job in job.assembly_jobs):
                deque_self.append(job)
            return -1, None

        # ğŸˆ ä»æ‰€éœ€å·¥ä»¶é˜Ÿåˆ—ä¸­å–å‡ºä¸€ä¸ªå·¥ä»¶
        # å¦‚æœå­˜åœ¨æ»¡è¶³æ¡ä»¶çš„å·¥ä»¶ï¼Œä»é˜Ÿåˆ—ä¸­å¼¹å‡ºè¯¥å·¥ä»¶ï¼Œè¡¨ç¤ºåŒ¹é…æˆåŠŸ
        # job_need = deque_need.pop()
        deque_need.remove(job_need)

        # ğŸˆ æ›´æ–°å½“å‰æ“ä½œçš„è£…é…ä¿¡æ¯
        # è®°å½•è£…é…æ“ä½œçš„è¯¦ç»†ä¿¡æ¯ï¼ŒåŒ…æ‹¬è£…é…è§„åˆ™åã€å½“å‰å·¥ä»¶IDå’ŒåŒ¹é…å·¥ä»¶ID
        op.assemble_jobs.append((cur_assemble_style.name, job.id, job_need.id))

        # ğŸˆ æ›´æ–°å½“å‰å·¥ä»¶çš„ç±»å‹
        # è£…é…å®Œæˆåï¼Œå½“å‰å·¥ä»¶çš„ç±»å‹å˜æ›´ä¸ºè£…é…è§„åˆ™æ‰€å®šä¹‰çš„æ–°ç±»å‹
        job.style = cur_assemble_style
        job_need.style = cur_assemble_style
        job.assembly_jobs.add(job_need)
        job_need.assembly_jobs.add(job)

        assembly_jobs = set()

        for job_as_self in job.assembly_jobs:
            for job_as_need in job_need.assembly_jobs:
                assembly_jobs.add(job_as_self)
                assembly_jobs.add(job_as_need)
        for job_ in assembly_jobs:
            self.jobs[job_.id - 1].style = cur_assemble_style
            self.jobs[job_.id - 1].assembly_jobs = assembly_jobs
        # print()

        # ğŸˆ è·å–æ‰€éœ€å·¥ä»¶çš„å®Œæˆæ—¶é—´
        # ç”¨äºåˆ¤æ–­å½“å‰æ“ä½œçš„å¼€å§‹æ—¶é—´ï¼Œç¡®ä¿è£…é…ä¾èµ–æ¡ä»¶æ»¡è¶³
        prev_time_assembly = job_finished_times[job_need.id - 1][-1][1]

        # ğŸˆ è¿”å›è£…é…ä¾èµ–çš„å®Œæˆæ—¶é—´
        # å¦‚æœè£…é…æ¡ä»¶æ»¡è¶³ï¼Œåˆ™è¿”å›è£…é…ä¾èµ–çš„å·¥ä»¶å®Œæˆæ—¶é—´
        return prev_time_assembly, job_need

    def get_run_power_by_machine(self, machine_index):
        """
        é€šè¿‡æœºå™¨å·è·å–æœºå™¨çš„åŠ å·¥åŠŸç‡ã€‚

        Args:
            machine_index (int): æœºå™¨å·ã€‚

        Returns:
            int: å¯¹åº”æœºå™¨çš„åŠ å·¥èƒ½é‡ã€‚å¦‚æœæœºå™¨ä¸å­˜åœ¨ï¼Œè¿”å› -1ã€‚
        """
        return next((machine.run_power for machine in self.machines if machine.id == machine_index), -1)

    def get_idle_power_by_machine(self, machine_index):
        """
        é€šè¿‡æœºå™¨å·è·å–æœºå™¨çš„åŠ å·¥åŠŸç‡ã€‚

        Args:
            machine_index (int): æœºå™¨å·ã€‚

        Returns:
            int: å¯¹åº”æœºå™¨çš„åŠ å·¥èƒ½é‡ã€‚å¦‚æœæœºå™¨ä¸å­˜åœ¨ï¼Œè¿”å› -1ã€‚
        """
        return next((machine.idle_power for machine in self.machines if machine.id == machine_index), -1)
